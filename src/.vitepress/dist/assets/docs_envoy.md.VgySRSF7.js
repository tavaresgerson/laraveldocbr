import{_ as s,c as a,o as i,a4 as e}from"./chunks/framework.nQaBHiNx.js";const g=JSON.parse('{"title":"Laravel Envoy","description":"","frontmatter":{},"headers":[],"relativePath":"docs/envoy.md","filePath":"docs/envoy.md"}'),n={name:"docs/envoy.md"},t=e(`<h1 id="laravel-envoy" tabindex="-1">Laravel Envoy <a class="header-anchor" href="#laravel-envoy" aria-label="Permalink to &quot;Laravel Envoy&quot;">​</a></h1><p><a name="introduction"></a></p><h2 id="introducao" tabindex="-1">Introdução <a class="header-anchor" href="#introducao" aria-label="Permalink to &quot;Introdução&quot;">​</a></h2><p><a href="https://github.com/laravel/envoy" target="_blank" rel="noreferrer">Laravel Envoy</a> é uma ferramenta para executar tarefas comuns que você executa em seus servidores remotos. Usando a sintaxe de estilo <a href="/docs/blade.html">Blade</a>, você pode facilmente configurar tarefas para implantação, comandos Artisan e muito mais. Atualmente, o Envoy suporta apenas os sistemas operacionais Mac e Linux. No entanto, o suporte ao Windows pode ser obtido usando <a href="https://docs.microsoft.com/en-us/windows/wsl/install-win10" target="_blank" rel="noreferrer">WSL2</a>.</p><p><a name="installation"></a></p><h2 id="instalacao" tabindex="-1">Instalação <a class="header-anchor" href="#instalacao" aria-label="Permalink to &quot;Instalação&quot;">​</a></h2><p>Primeiro, instale o Envoy em seu projeto usando o gerenciador de pacotes do Composer:</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">composer</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> require</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> laravel/envoy</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --dev</span></span></code></pre></div><p>Depois que o Envoy for instalado, o binário do Envoy estará disponível no diretório <code>vendor/bin</code> do seu aplicativo:</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">php</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vendor/bin/envoy</span></span></code></pre></div><p><a name="writing-tasks"></a></p><h2 id="escrevendo-tarefas" tabindex="-1">Escrevendo tarefas <a class="header-anchor" href="#escrevendo-tarefas" aria-label="Permalink to &quot;Escrevendo tarefas&quot;">​</a></h2><p><a name="defining-tasks"></a></p><h3 id="definindo-tarefas" tabindex="-1">Definindo tarefas <a class="header-anchor" href="#definindo-tarefas" aria-label="Permalink to &quot;Definindo tarefas&quot;">​</a></h3><p>As tarefas são o bloco de construção básico do Envoy. As tarefas definem os comandos de shell que devem ser executados em seus servidores remotos quando a tarefa é invocada. Por exemplo, você pode definir uma tarefa que executa o comando <code>php artisan queue:restart</code> em todos os servidores de trabalho de fila do seu aplicativo.</p><p>Todas as suas tarefas do Envoy devem ser definidas em um arquivo <code>Envoy.blade.php</code> na raiz do seu aplicativo. Aqui está um exemplo para você começar:</p><div class="language-blade vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">blade</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@servers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;web&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;user@192.168.1.1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;workers&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;user@192.168.1.2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]])</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@task</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;restart-queues&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;on&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;workers&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cd /home/user/example.com</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    php artisan queue:restart</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@endtask</span></span></code></pre></div><p>Como você pode ver, uma matriz de <code>@servers</code> é definida no topo do arquivo, permitindo que você faça referência a esses servidores por meio da opção <code>on</code> de suas declarações de tarefa. A declaração <code>@servers</code> deve sempre ser colocada em uma única linha. Dentro de suas declarações <code>@task</code>, você deve colocar os comandos shell que devem ser executados em seus servidores quando a tarefa for invocada.</p><p><a name="local-tasks"></a></p><h4 id="tarefas-locais" tabindex="-1">Tarefas locais <a class="header-anchor" href="#tarefas-locais" aria-label="Permalink to &quot;Tarefas locais&quot;">​</a></h4><p>Você pode forçar um script a ser executado no seu computador local especificando o endereço IP do servidor como <code>127.0.0.1</code>:</p><div class="language-blade vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">blade</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@servers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;localhost&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;127.0.0.1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span></code></pre></div><p><a name="importing-envoy-tasks"></a></p><h4 id="importando-tarefas-do-envoy" tabindex="-1">Importando tarefas do Envoy <a class="header-anchor" href="#importando-tarefas-do-envoy" aria-label="Permalink to &quot;Importando tarefas do Envoy&quot;">​</a></h4><p>Usando a diretiva <code>@import</code>, você pode importar outros arquivos do Envoy para que suas histórias e tarefas sejam adicionadas às suas. Após os arquivos terem sido importados, você pode executar as tarefas que eles contêm como se estivessem definidas no seu próprio arquivo do Envoy:</p><div class="language-blade vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">blade</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;vendor/package/Envoy.blade.php&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p><a name="multiple-servers"></a></p><h3 id="varios-servidores" tabindex="-1">Vários servidores <a class="header-anchor" href="#varios-servidores" aria-label="Permalink to &quot;Vários servidores&quot;">​</a></h3><p>O Envoy permite que você execute facilmente uma tarefa em vários servidores. Primeiro, adicione servidores adicionais à sua declaração <code>@servers</code>. Cada servidor deve receber um nome exclusivo. Depois de definir seus servidores adicionais, você pode listar cada um dos servidores no array <code>on</code> da tarefa:</p><div class="language-blade vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">blade</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@servers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;web-1&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;192.168.1.1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;web-2&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;192.168.1.2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@task</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;deploy&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;on&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;web-1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;web-2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cd /home/user/example.com</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    git pull origin </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $branch </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    php artisan migrate --force</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@endtask</span></span></code></pre></div><p><a name="parallel-execution"></a></p><h4 id="execucao-paralela" tabindex="-1">Execução paralela <a class="header-anchor" href="#execucao-paralela" aria-label="Permalink to &quot;Execução paralela&quot;">​</a></h4><p>Por padrão, as tarefas serão executadas em cada servidor em série. Em outras palavras, uma tarefa terminará de ser executada no primeiro servidor antes de prosseguir para a execução no segundo servidor. Se você quiser executar uma tarefa em vários servidores em paralelo, adicione a opção <code>parallel</code> à sua declaração de tarefa:</p><div class="language-blade vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">blade</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@servers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;web-1&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;192.168.1.1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;web-2&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;192.168.1.2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@task</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;deploy&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;on&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;web-1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;web-2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;parallel&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cd /home/user/example.com</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    git pull origin </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $branch </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    php artisan migrate --force</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@endtask</span></span></code></pre></div><p><a name="setup"></a></p><h3 id="configuracao" tabindex="-1">Configuração <a class="header-anchor" href="#configuracao" aria-label="Permalink to &quot;Configuração&quot;">​</a></h3><p>Às vezes, você pode precisar executar código PHP arbitrário antes de executar suas tarefas do Envoy. Você pode usar a diretiva <code>@setup</code> para definir um bloco de código PHP que deve ser executado antes de suas tarefas:</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setup</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    $now </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> DateTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">endsetup</span></span></code></pre></div><p>Se você precisar exigir outros arquivos PHP antes que sua tarefa seja executada, você pode usar a diretiva <code>@include</code> no topo do seu arquivo <code>Envoy.blade.php</code>:</p><div class="language-blade vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">blade</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@include</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;vendor/autoload.php&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@task</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;restart-queues&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    # ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@endtask</span></span></code></pre></div><p><a name="variables"></a></p><h3 id="variaveis" tabindex="-1">Variáveis <a class="header-anchor" href="#variaveis" aria-label="Permalink to &quot;Variáveis&quot;">​</a></h3><p>Se necessário, você pode passar argumentos para tarefas do Envoy especificando-os na linha de comando ao invocar o Envoy:</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">php</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vendor/bin/envoy</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deploy</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --branch=master</span></span></code></pre></div><p>Você pode acessar as opções dentro de suas tarefas usando a sintaxe &quot;echo&quot; do Blade. Você também pode definir instruções e loops <code>if</code> do Blade dentro de suas tarefas. Por exemplo, vamos verificar a presença da variável <code>$branch</code> antes de executar o comando <code>git pull</code>:</p><div class="language-blade vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">blade</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@servers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;web&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;user@192.168.1.1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]])</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@task</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;deploy&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;on&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;web&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cd /home/user/example.com</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    @if </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($branch)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        git pull origin </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $branch </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    @endif</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    php artisan migrate --force</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@endtask</span></span></code></pre></div><p><a name="stories"></a></p><h3 id="historias" tabindex="-1">Histórias <a class="header-anchor" href="#historias" aria-label="Permalink to &quot;Histórias&quot;">​</a></h3><p>As histórias agrupam um conjunto de tarefas sob um único nome conveniente. Por exemplo, uma história <code>deploy</code> pode executar as tarefas <code>update-code</code> e <code>install-dependencies</code> listando os nomes das tarefas dentro de sua definição:</p><div class="language-blade vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">blade</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@servers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;web&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;user@192.168.1.1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]])</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@story</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;deploy&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    update-code</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    install-dependencies</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@endstory</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@task</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;update-code&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cd /home/user/example.com</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    git pull origin master</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@endtask</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@task</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;install-dependencies&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cd /home/user/example.com</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    composer install</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@endtask</span></span></code></pre></div><p>Depois que a história for escrita, você pode invocá-la da mesma forma que invocaria uma tarefa:</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">php</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vendor/bin/envoy</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deploy</span></span></code></pre></div><p><a name="completion-hooks"></a></p><h3 id="ganchos" tabindex="-1">Ganchos <a class="header-anchor" href="#ganchos" aria-label="Permalink to &quot;Ganchos&quot;">​</a></h3><p>Quando tarefas e histórias são executadas, vários ganchos são executados. Os tipos de ganchos suportados pelo Envoy são <code>@before</code>, <code>@after</code>, <code>@error</code>, <code>@success</code> e <code>@finished</code>. Todo o código nesses ganchos é interpretado como PHP e executado localmente, não nos servidores remotos com os quais suas tarefas interagem.</p><p>Você pode definir quantos desses ganchos quiser. Eles serão executados na ordem em que aparecem no seu script Envoy.</p><p><a name="hook-before"></a></p><h4 id="before" tabindex="-1"><code>@before</code> <a class="header-anchor" href="#before" aria-label="Permalink to &quot;\`@before\`&quot;">​</a></h4><p>Antes da execução de cada tarefa, todos os ganchos <code>@before</code> registrados no seu script Envoy serão executados. Os ganchos <code>@before</code> recebem o nome da tarefa que será executada:</p><div class="language-blade vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">blade</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@before</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    if ($task === &#39;deploy&#39;) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@endbefore</span></span></code></pre></div><p><a name="completion-after"></a></p><h4 id="after" tabindex="-1"><code>@after</code> <a class="header-anchor" href="#after" aria-label="Permalink to &quot;\`@after\`&quot;">​</a></h4><p>Após a execução de cada tarefa, todos os ganchos <code>@after</code> registrados no seu script Envoy serão executados. Os ganchos <code>@after</code> recebem o nome da tarefa que foi executada:</p><div class="language-blade vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">blade</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@after</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    if ($task === &#39;deploy&#39;) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@endafter</span></span></code></pre></div><p><a name="completion-error"></a></p><h4 id="error" tabindex="-1"><code>@error</code> <a class="header-anchor" href="#error" aria-label="Permalink to &quot;\`@error\`&quot;">​</a></h4><p>Após cada falha de tarefa (sai com um código de status maior que <code>0</code>), todos os ganchos <code>@error</code> registrados no seu script Envoy serão executados. Os ganchos <code>@error</code> recebem o nome da tarefa que foi executada:</p><div class="language-blade vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">blade</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@error</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    if ($task === &#39;deploy&#39;) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@enderror</span></span></code></pre></div><p><a name="completion-success"></a></p><h4 id="success" tabindex="-1"><code>@success</code> <a class="header-anchor" href="#success" aria-label="Permalink to &quot;\`@success\`&quot;">​</a></h4><p>Se todas as tarefas foram executadas sem erros, todos os ganchos <code>@success</code> registrados no seu script Envoy serão executados:</p><div class="language-blade vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">blade</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@success</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@endsuccess</span></span></code></pre></div><p><a name="completion-finished"></a></p><h4 id="finished" tabindex="-1"><code>@finished</code> <a class="header-anchor" href="#finished" aria-label="Permalink to &quot;\`@finished\`&quot;">​</a></h4><p>Após todas as tarefas terem sido executadas (independentemente do status de saída), todos os ganchos <code>@finished</code> serão executados. Os ganchos <code>@finished</code> recebem o código de status da tarefa concluída, que pode ser <code>null</code> ou um <code>integer</code> maior ou igual a <code>0</code>:</p><div class="language-blade vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">blade</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@finished</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    if ($exitCode &gt; 0) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        // There were errors in one of the tasks...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@endfinished</span></span></code></pre></div><p><a name="running-tasks"></a></p><h2 id="executando-tarefas" tabindex="-1">Executando tarefas <a class="header-anchor" href="#executando-tarefas" aria-label="Permalink to &quot;Executando tarefas&quot;">​</a></h2><p>Para executar uma tarefa ou história definida no arquivo <code>Envoy.blade.php</code> do seu aplicativo, execute o comando <code>run</code> do Envoy, passando o nome da tarefa ou história que você gostaria de executar. O Envoy executará a tarefa e exibirá a saída dos seus servidores remotos enquanto a tarefa estiver em execução:</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">php</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vendor/bin/envoy</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deploy</span></span></code></pre></div><p><a name="confirming-task-execution"></a></p><h3 id="confirmando-a-execucao-da-tarefa" tabindex="-1">Confirmando a execução da tarefa <a class="header-anchor" href="#confirmando-a-execucao-da-tarefa" aria-label="Permalink to &quot;Confirmando a execução da tarefa&quot;">​</a></h3><p>Se você quiser ser solicitado a confirmar antes de executar uma determinada tarefa em seus servidores, adicione a diretiva <code>confirm</code> à sua declaração de tarefa. Esta opção é particularmente útil para operações destrutivas:</p><div class="language-blade vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">blade</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@task</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;deploy&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;on&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;web&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;confirm&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cd /home/user/example.com</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    git pull origin </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $branch </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    php artisan migrate</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@endtask</span></span></code></pre></div><p><a name="notifications"></a></p><h2 id="notificacoes" tabindex="-1">Notificações <a class="header-anchor" href="#notificacoes" aria-label="Permalink to &quot;Notificações&quot;">​</a></h2><p><a name="slack"></a></p><h3 id="slack" tabindex="-1">Slack <a class="header-anchor" href="#slack" aria-label="Permalink to &quot;Slack&quot;">​</a></h3><p>O Envoy oferece suporte ao envio de notificações para <a href="https://slack.com" target="_blank" rel="noreferrer">Slack</a> após cada tarefa ser executada. A diretiva <code>@slack</code> aceita uma URL de hook do Slack e um nome de canal/usuário. Você pode recuperar sua URL de webhook criando uma integração &quot;Incoming WebHooks&quot; no seu painel de controle do Slack.</p><p>Você deve passar a URL inteira do webhook como o primeiro argumento fornecido à diretiva <code>@slack</code>. O segundo argumento dado à diretiva <code>@slack</code> deve ser um nome de canal (<code>#channel</code>) ou um nome de usuário (<code>@user</code>):</p><div class="language-blade vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">blade</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@finished</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    @slack</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;webhook-url&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;#bots&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@endfinished</span></span></code></pre></div><p>Por padrão, as notificações do Envoy enviarão uma mensagem ao canal de notificação descrevendo a tarefa que foi executada. No entanto, você pode substituir esta mensagem com sua própria mensagem personalizada passando um terceiro argumento para a diretiva <code>@slack</code>:</p><div class="language-blade vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">blade</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@finished</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    @slack</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;webhook-url&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;#bots&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Hello, Slack.&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@endfinished</span></span></code></pre></div><p><a name="discord"></a></p><h3 id="discord" tabindex="-1">Discord <a class="header-anchor" href="#discord" aria-label="Permalink to &quot;Discord&quot;">​</a></h3><p>O Envoy também suporta o envio de notificações para <a href="https://discord.com" target="_blank" rel="noreferrer">Discord</a> após cada tarefa ser executada. A diretiva <code>@discord</code> aceita uma URL de hook do Discord e uma mensagem. Você pode recuperar sua URL de webhook criando um &quot;Webhook&quot; nas suas Configurações do Servidor e escolhendo em qual canal o webhook deve ser postado. Você deve passar o URL do Webhook inteiro para a diretiva <code>@discord</code>:</p><div class="language-blade vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">blade</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@finished</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    @discord</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;discord-webhook-url&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@endfinished</span></span></code></pre></div><p><a name="telegram"></a></p><h3 id="telegram" tabindex="-1">Telegram <a class="header-anchor" href="#telegram" aria-label="Permalink to &quot;Telegram&quot;">​</a></h3><p>O Envoy também suporta o envio de notificações para o <a href="https://telegram.org" target="_blank" rel="noreferrer">Telegram</a> após cada tarefa ser executada. A diretiva <code>@telegram</code> aceita um ID de bot do Telegram e um ID de bate-papo. Você pode recuperar seu ID de bot criando um novo bot usando <a href="https://t.me/botfather" target="_blank" rel="noreferrer">BotFather</a>. Você pode recuperar um ID de bate-papo válido usando <a href="https://t.me/username_to_id_bot" target="_blank" rel="noreferrer">@username_to_id_bot</a>. Você deve passar o ID do bot e o ID do chat inteiros para a diretiva <code>@telegram</code>:</p><div class="language-blade vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">blade</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@finished</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    @telegram</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;bot-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;chat-id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@endfinished</span></span></code></pre></div><p><a name="microsoft-teams"></a></p><h3 id="microsoft-teams" tabindex="-1">Microsoft Teams <a class="header-anchor" href="#microsoft-teams" aria-label="Permalink to &quot;Microsoft Teams&quot;">​</a></h3><p>O Envoy também oferece suporte ao envio de notificações para o <a href="https://www.microsoft.com/en-us/microsoft-teams" target="_blank" rel="noreferrer">Microsoft Teams</a> após cada tarefa ser executada. A diretiva <code>@microsoftTeams</code> aceita um Teams Webhook (obrigatório), uma mensagem, cor do tema (sucesso, informação, aviso, erro) e uma série de opções. Você pode recuperar seu Teams Webhook criando um novo <a href="https://docs.microsoft.com/en-us/microsoftteams/platform/webhooks-and-connectors/how-to/add-incoming-webhook" target="_blank" rel="noreferrer">incoming webhook</a>. A API do Teams tem muitos outros atributos para personalizar sua caixa de mensagem, como título, resumo e seções. Você pode encontrar mais informações na <a href="https://docs.microsoft.com/en-us/microsoftteams/platform/webhooks-and-connectors/how-to/connectors-using?tabs=cURL#example-of-connector-message" target="_blank" rel="noreferrer">documentação do Microsoft Teams</a>. Você deve passar a URL inteira do Webhook para a diretiva <code>@microsoftTeams</code>:</p><div class="language-blade vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">blade</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@finished</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    @microsoftTeams</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;webhook-url&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@endfinished</span></span></code></pre></div>`,105),o=[t];function l(p,h,r,d,k,c){return i(),a("div",null,o)}const u=s(n,[["render",l]]);export{g as __pageData,u as default};
